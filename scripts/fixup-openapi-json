#!/usr/bin/env node

const SUPPORTED = [
  '/version',
  '/status',
  '/channels',
  '/channels/{type}/{channel}/stream',
  '/channels/{type}/{channel}/services/{id}/stream',
  '/services',
  '/services/{id}',
  '/services/{id}/logo',
  '/services/{id}/stream',
  '/programs',
  '/programs/{id}',
  '/programs/{id}/stream',
  '/tuners',
  '/docs',
];

let chunks = [];

process.stdin.setEncoding('utf8');
process.stdin.on('data', (chunk) => chunks.push(chunk));
process.stdin.on('end', () => {
  let json = chunks.join('');
  let swagger = JSON.parse(json);

  swagger.info = {
    title: 'Web API endpoints for Mirakurun.Client',
    version: swagger.info.version,
    description: 'Generated by `mirakurun-openapi-json | fixup-openapi-json`'
  };

  let paths = {};
  for (const [path, data] of Object.entries(swagger.paths)) {
    if (SUPPORTED.includes(path)) {
      paths[path] = data;
    }
  }

  swagger.paths = paths;

  // `swagger.paths[].parameters` must exist even when it's an empty array.
  // That causes the following error in EPGStation:
  //
  //   [ERROR] system - mirakurun updater failed
  //   [ERROR] system - TypeError: p.parameters is not iterable
  //     at Client.call (/app/node_modules/mirakurun/lib/client.js:99:36)
  //     at processTicksAndRejections (internal/process/task_queues.js:97:5)
  //     at async Client.getServices (/app/node_modules/mirakurun/lib/client.js:186:21)
  //   [ERROR] system - MirakurunUpdater abort
  //
  // `swagger.paths[].<method>.parameters` can be omitted without any error.
  delete swagger.paths['/channels'].get.parameters;
  delete swagger.paths['/services'].get.parameters;
  delete swagger.paths['/programs'].get.parameters;

  swagger.definitions.Version = {
    type: 'string',
  };

  swagger.definitions.Status = {
    type: 'object',
    properties: {},
  };

  // TODO
  // ----
  // The pre-filters and the post-filters query parameters should be added to
  // the following endpoints:
  //
  //   * /channels/{type}/{channel}/stream
  //   * /channels/{type}/{channel}/services/{id}/stream
  //   * /services/{id}/stream
  //   * /programs/{id}/stream
  //
  // However, that makes no sense because Mirakurun.Client doesn't support
  // nested query strings at this point.  It uses `querystring` instead of `qs`
  // which supports nested query strings.
  //
  // For example, `querystring.stringify({ 'post-filters': ['filter1', 'filter2']})`
  // returns `'post-filters=filter1&post-filters=filter2'`, but it should be
  // `'post-filters[]=filter1&post-filters[]=filter2'` in the nested query
  // string format.
  //
  // Details of the nested query string format can be saw in the following pages:
  //
  //   * https://www.npmjs.com/package/qs
  //   * https://github.com/derekstavis/go-qs
  //   * https://github.com/rack/rack/blob/rack-1.3/test/spec_utils.rb#L10
  //   * https://github.com/samscott89/serde_qs/blob/main/tests/test_deserialize.rs

  console.log(JSON.stringify(swagger));
});
