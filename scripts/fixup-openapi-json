#!/usr/bin/env node

const SUPPORTED = [
  '/version',
  '/status',
  '/channels',
  '/services',
  '/services/{id}',
  '/programs',
  '/programs/{id}',
  '/tuners',
  '/channels/{type}/{channel}/stream',
  '/channels/{type}/{channel}/services/{id}/stream',
  '/services/{id}/stream',
  '/programs/{id}/stream',
  '/docs',
];

let chunks = [];

process.stdin.setEncoding('utf8');
process.stdin.on('data', (chunk) => chunks.push(chunk));
process.stdin.on('end', () => {
  let json = chunks.join('');
  let swagger = JSON.parse(json);

  swagger.info = {
    title: 'Web API endpoints for Mirakurun.Client',
    version: swagger.info.version,
    description: 'Generated by `mirakurun-openapi-json | fixup-openapi-json`'
  };

  let paths = {};
  for (const [path, data] of Object.entries(swagger.paths)) {
    if (SUPPORTED.includes(path)) {
      paths[path] = data;
    }
  }

  swagger.paths = paths;

  // `swagger.paths[].parameters` must exist even when it's an empty array.
  // That causes the following error in EPGStation:
  //
  //   [ERROR] system - mirakurun updater failed
  //   [ERROR] system - TypeError: p.parameters is not iterable
  //     at Client.call (/app/node_modules/mirakurun/lib/client.js:99:36)
  //     at processTicksAndRejections (internal/process/task_queues.js:97:5)
  //     at async Client.getServices (/app/node_modules/mirakurun/lib/client.js:186:21)
  //   [ERROR] system - MirakurunUpdater abort
  //
  // `swagger.paths[].<method>.parameters` can be omitted without any error.
  delete swagger.paths['/channels'].get.parameters;
  delete swagger.paths['/services'].get.parameters;
  delete swagger.paths['/programs'].get.parameters;

  swagger.definitions.Version = {
    type: 'string',
  };

  swagger.definitions.Status = {
    type: 'object',
    properties: {},
  };

  console.log(JSON.stringify(swagger));
});
