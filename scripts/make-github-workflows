#!/bin/sh -eu

PROGNAME=$(basename $0)
BASEDIR=$(cd $(dirname $0); pwd)
PROJDIR=$(cd $BASEDIR/..; pwd)

if [ "$(uname)" != Linux ] || id -nG | grep -q docker; then
  DOCKER='docker'
else
  DOCKER='sudo docker'
fi

HEADER=$(cat <<EOF
# DO NOT EDIT THIS FILE BY HAND.
#
# This file was generated by scripts/make-github-workflows automagically.
EOF
)

cat <<EOF >$PROJDIR/.github/workflows/ci.yml
$HEADER
$($DOCKER run --rm -v $PROJDIR/.github/workflows/templates:/workdir \
    docker.io/mikefarah/yq ea '. as $item ireduce ({}; . *d $item)' \
    ci.workflow.yml \
    build.job.yml \
    cross-build.job.yml \
    coverage.job.yml \
)
EOF

cat <<EOF >$PROJDIR/.github/workflows/release.yml
$HEADER
$($DOCKER run --rm -v $PROJDIR/.github/workflows/templates:/workdir \
    docker.io/mikefarah/yq ea '. as $item ireduce ({}; . *d $item)' \
    release.workflow.yml \
    docker.job.yml \
)
EOF

cat <<EOF >$PROJDIR/.github/workflows/pull-request.yml
$HEADER
$($DOCKER run --rm -v $PROJDIR/.github/workflows/templates:/workdir \
    docker.io/mikefarah/yq ea '. as $item ireduce ({}; . *d $item)' \
    pull-request.workflow.yml \
    build.job.yml \
    cross-build.job.yml \
    coverage.job.yml \
)
EOF

cat <<EOF >$PROJDIR/.github/workflows/daily-main.yml
$HEADER
$($DOCKER run --rm -v $PROJDIR/.github/workflows/templates:/workdir \
    docker.io/mikefarah/yq ea '. as $item ireduce ({}; . *d $item)' \
    daily-main.workflow.yml \
    update.job.yml \
    docker.job.yml \
)
EOF

cat <<EOF >$PROJDIR/.github/workflows/daily-release.yml
$HEADER
$($DOCKER run --rm -v $PROJDIR/.github/workflows/templates:/workdir \
    docker.io/mikefarah/yq ea '. as $item ireduce ({}; . *d $item)' \
    daily-release.workflow.yml \
    update.job.yml \
)
EOF
