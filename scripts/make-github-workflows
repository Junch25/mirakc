#!/bin/sh

set -eu

PROGNAME=$(basename $0)
BASEDIR=$(cd $(dirname $0); pwd)
PROJDIR=$(cd $BASEDIR/..; pwd)

HEADER=$(cat <<EOF
# DO NOT EDIT THIS FILE BY HAND.
#
# This file was generated by scripts/make-github-workflows automagically.
EOF
)

cat <<EOF >$PROJDIR/.github/workflows/ci.yml
$HEADER
$(docker run --rm -v $BASEDIR/github/workflows:/workdir mikefarah/yq:3 yq m \
    ci.workflow.yml \
    build.job.yml \
    cross-build.job.yml \
    coverage.job.yml \
    docker.job.yml \
)
EOF

cat <<EOF >$PROJDIR/.github/workflows/release.yml
$HEADER
$(docker run --rm -v $BASEDIR/github/workflows:/workdir mikefarah/yq:3 yq m \
    release.workflow.yml \
    docker.job.yml \
)
EOF

cat <<EOF >$PROJDIR/.github/workflows/pull-request.yml
$HEADER
$(docker run --rm -v $BASEDIR/github/workflows:/workdir mikefarah/yq:3 yq m \
    pull-request.workflow.yml \
    build.job.yml \
    cross-build.job.yml \
    coverage.job.yml \
    auto-merge.job.yml \
)
EOF
