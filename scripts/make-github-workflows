#!/bin/sh -eu

PROGNAME=$(basename $0)
BASEDIR=$(cd $(dirname $0); pwd)
PROJDIR=$(cd $BASEDIR/..; pwd)

if [ "$(uname)" != Linux ] || id -nG | grep -q docker; then
  DOCKER='docker'
else
  DOCKER='sudo docker'
fi

HEADER=$(cat <<EOF
# DO NOT EDIT THIS FILE BY HAND.
#
# This file was generated by scripts/make-github-workflows automagically.
EOF
)

cat <<EOF >$PROJDIR/.github/workflows/ci.yml
$HEADER
$($DOCKER run --rm -v $BASEDIR/github/workflows:/workdir mikefarah/yq:3 yq m \
    ci.workflow.yml \
    build.job.yml \
    cross-build.job.yml \
    coverage.job.yml \
    docker.job.yml \
)
EOF

cat <<EOF >$PROJDIR/.github/workflows/release.yml
$HEADER
$($DOCKER run --rm -v $BASEDIR/github/workflows:/workdir mikefarah/yq:3 yq m \
    release.workflow.yml \
    docker.job.yml \
)
EOF

cat <<EOF >$PROJDIR/.github/workflows/pull-request.yml
$HEADER
$($DOCKER run --rm -v $BASEDIR/github/workflows:/workdir mikefarah/yq:3 yq m \
    pull-request.workflow.yml \
    build.job.yml \
    cross-build.job.yml \
    coverage.job.yml \
)
EOF
